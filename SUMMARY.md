# Реализация предварительного анализа звонков

## Общее описание
Добавлена новая функциональность - предварительный анализ звонков перед полным анализом всех звонков. Система анализирует первые 5 звонков, чтобы понять общий контекст и сформировать ключевые вопросы для детального анализа.

## Ключевые компоненты
1. **Backend API-эндпоинт `/api/preview-analyze`**:
   - Анализирует первые 5 звонков для понимания контекста
   - Возвращает отчет о сути звонков, советы по анализу и 3 ключевых вопроса

2. **Компонент `PreviewAnalysis`**:
   - Отображает результаты предварительного анализа
   - Содержит обзорный отчет, рекомендации LLM и ключевые вопросы

3. **Интеграция с таблицей звонков**:
   - Добавлены новые столбцы для ответов на ключевые вопросы
   - Динамические заголовки столбцов на основе результатов анализа

4. **Расширенный анализ звонков**:
   - Функция анализа звонков дополнена для ответов на ключевые вопросы
   - Информация сохраняется и отображается в деталях каждого звонка

## Интерфейс пользователя
1. Начальный экран предварительного анализа на вкладке "Анализ звонков" с описанием функциональности
2. После анализа отображается:
   - Отчет с описанием сути звонков, целей, продукта и этапа воронки
   - Совет от LLM о том, что важно анализировать в первую очередь
   - 3 ключевых вопроса с полями для общих ответов
3. Таблица звонков обновляется с новыми столбцами для ответов на вопросы
4. Детали звонков получают новую вкладку "Ключевые вопросы" с ответами для конкретного звонка

## Преимущества
1. Помогает понять контекст данных без необходимости анализировать все звонки
2. Автоматически определяет наиболее важные аспекты для анализа
3. Формирует структурированные вопросы для сравнения звонков
4. Улучшает качество и релевантность анализа

## Технические детали
1. API-вызовы используют Gemini API или Groq в качестве резервного варианта
2. Результаты кэшируются в React-состоянии и передаются в последующие этапы анализа
3. Модифицированы существующие компоненты для поддержки новых полей 

## Исправления проблемы с отображением ответа на запрос пользователя

1. **Модификация функции `custom_analyze_transcript` в API:**
   - Добавлено новое поле `customResponse`, которое содержит прямой ответ на пользовательский запрос
   - Обновлено формирование промпта для LLM с инструкцией генерировать ответ на запрос
   - Добавлена обработка случаев, когда поле отсутствует в ответе

2. **Обновление интерфейса `Call` в таблице звонков:**
   - Добавлены новые поля `evaluation`, `keyPoints` и `issues` для хранения результатов анализа
   - Решены проблемы линтера для полей `managerPerformance` и `customerPotential`

3. **Улучшение отображения в таблице звонков:**
   - Модифицирован код отображения поля `customResponse` в таблице
   - Обновлены ячейки для отображения результатов в соответствии с новыми структурами данных
   
4. **Обновление функций для анализа звонков:**
   - Добавлено сохранение поля `customResponse` в функции `handleAnalyze`
   - Добавлено сохранение поля `customResponse` в функции `handleAnalysisSubmit`
   - Реализовано автоматическое формирование ответа даже при отсутствии данных от LLM

5. **Реализация API-эндпоинта для предварительного анализа звонков:**
   - Добавлен новый API-эндпоинт `/api/preview-analyze`
   - Создана функция `preview_analyze_calls` для анализа первых звонков
   - Реализован базовый анализ `basic_preview_analysis` без использования LLM

Теперь все столбцы таблицы звонков заполняются автоматически, включая столбец "Ответ на запрос", который подгружает ответ исходя из запроса пользователя, введенного в графе блока "Обработка звонков". 